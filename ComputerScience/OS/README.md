# å¯„å­˜å™¨



# åº”ç”¨ç¨‹åºçœ¼ä¸­çš„æ“ä½œç³»ç»Ÿ

* ä»€ä¹ˆæ˜¯åº”ç”¨ç¨‹åº







# ç¡¬ä»¶çœ¼ä¸­çš„æ“ä½œç³»ç»Ÿ

> çŠ¶æ€åŠã€Cç¨‹åº

>  https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html#nine-volume
>
> intelå¤„ç†å™¨ cpu reset ä¹‹åçš„çŠ¶æ€å¯ä»¥ä»æ‰‹å†Œä¸­è¯»åˆ°ã€‚æœ€éœ€è¦å…³æ³¨çš„æ˜¯ 3a
>
> https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia-32-architectures-sdm-volume-3a-system-programming-guide-part-1.html

ä¸ºäº†è®©è®¡ç®—æœºå¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»æ„ç¨‹åºï¼Œä¸€å®šä¼šå­˜åœ¨ä¸€äº›è½¯ä»¶/ç¡¬ä»¶çº¦å®š

* CPU reset åï¼Œå¤„ç†å™¨å‡ºäºæŸä¸ªç¡®å®šçš„çŠ¶æ€ã€‚`9.1.1 Processor State After Reset`
  * PCæŒ‡é’ˆä¸€èˆ¬æŒ‡å‘ä¸€æ®µ memory-mapped ROM
    * ROMå­˜å‚¨äº†å‚å•†æä¾›çš„firm-ware
  * å¤„ç†å™¨çš„å¤§éƒ¨åˆ†åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€
    * ç¼“å­˜ï¼Œè™šæ‹Ÿå­˜å‚¨ï¼Œã€‚ã€‚ã€‚
* Firmwareï¼šU-boot(å¼€æºé¡¹ç›®)
  * å°†ç”¨æˆ·æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼ˆç£ç›˜ä¸Šçš„æ•°æ®->å†…å­˜ï¼‰
    * ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§loader
    * æ´»ç€ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿï¼ˆåµŒå…¥å¼ï¼‰
  * Legcy bios çº¦å®š
    * legacy bios ä¼šå°†å¼•å¯¼ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ˆä¸»å¼•å¯¼æ‰‡åŒºï¼ŒMBRï¼‰åŠ è½½åˆ°å†…å­˜ `7c00` ä½ç½®
      * å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼
      * ç„¶åå°† CS:IP æŒ‡å‘ `7c00`. ä¹‹å cpu å°±ä¼šæ‰§è¡Œ ä¸»å¼•å¯¼æ‰‡åŒºçš„ä»£ç äº†ã€‚
    * å…¶å®ƒæ²¡æœ‰ä»»ä½•çº¦æŸ
    * https://www.usenix.org/legacy/event/usenix05/tech/freenix/full_papers/bellard/bellard.pdf
    * Seabios: qemu é»˜è®¤çš„bios



å…³äºç³»ç»Ÿé•œåƒæ–‡ä»¶ï¼š

* å‰512å­—èŠ‚ï¼Œç‰¹æ®Šçš„ä¸»å¼•å¯¼æ‰‡åŒº ï¼ˆä¸€æ®µæ±‡ç¼–ä»£ç ï¼Œç”¨æ¥è®¾ç½®cpuã€‚ç„¶åæ‰§è¡ŒåŠ è½½kernelåˆ°å†…å­˜ï¼Œè¿™æ®µä»£ç æ˜¯ç”¨cå†™çš„ã€‚ï¼‰
  * cpu 16-bit åˆ° 32-bit çš„åˆ‡æ¢
  * Elf32 & elf64çš„åŠ è½½å™¨
    * çº¦å®šï¼šmainå‡½æ•°å‚æ•°ä½äºç£ç›˜çš„ 512å­—èŠ‚ï½
    * ELFä½äºç£ç›˜çš„ 512 + 1024 å­—èŠ‚ï½
* ç„¶å 1024 å­—èŠ‚çš„ç©ºç™½ï¼šmainå‡½æ•°çš„å‚æ•°
* ç„¶åæ˜¯ elf æ–‡ä»¶



å…³äºä¸»å¼•å¯¼æ‰‡åŒºï¼šä¸€èˆ¬åšä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿ

* 



# æ“ä½œç³»ç»Ÿä¸­çš„äº’æ–¥

> æ³¨æ„ä¸æ˜¯åº”ç”¨ç¨‹åºçš„äº’æ–¥å“¦ã€‚



# malloc & free

* è¿›ç¨‹ä¼šå‘æ“ä½œç³»ç»Ÿè¯·æ±‚ä¸€ä¸ªå¤§å—å†…å­˜

* è¯·æ±‚åˆ°ä¹‹å

* è¿›ç¨‹ä¼šä»è¿™ä¸ªå¤§å—å†…å­˜ä¸­è¿›è¡Œåˆ†é…ã€‚ï¼ˆå†åˆ†é…çš„ä»£ç ç”±ç”¨æˆ·ç¼–å†™ï¼‰

* æ“ä½œç³»ç»Ÿæä¾›ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨

  * ```c++
    void *sbrk(intptr_t increment); //å¤ä»£æ–¹æ³• brk
    void *mmap(void *addr, size_t length, int port, int flags, int fd, off_t offset); //ç°ä»£æ–¹æ³•
    ```



å¦‚æœè¦å®ç° malloc & free åº”è¯¥æ€ä¹ˆåšï¼Ÿ

* é¦–å…ˆç†è§£é—®é¢˜æ˜¯ä»€ä¹ˆï¼Œç„¶åå†è°ˆè§£å†³æ–¹æ¡ˆã€‚ï¼ˆä½¿ç”¨å¥½ trace/profiler ç¡®å®šé—®é¢˜æ˜¯ä»€ä¹ˆã€‚



# åŒæ­¥

* è‡ªæ—‹é”
* æ¡ä»¶å˜é‡
* ä¿¡å·é‡ï¼ˆæ¯”æ¡ä»¶å˜é‡high levelï¼‰
* 



# è°ƒè¯•ç†è®ºç»™æˆ‘ä»¬çš„å¯ç¤º

> ä»€ä¹ˆæ˜¯bugï¼šç¨‹åºæ‰§è¡Œçš„ç»“æœä¸æœŸæœ›çš„ç»“æœä¸ç¬¦
>
> å¦‚ä½•æ‰¾åˆ°bugï¼šå°†bug è½¬æˆ ç¨‹åºé”™è¯¯ï¼ˆassertionsï¼‰ç­‰ç­‰ã€‚ã€‚ã€‚



**ç¨‹åºè¿è¡Œæœ¬è´¨æ˜¯çŠ¶æ€æœº**



æ‰¾åˆ°bugçš„ä¸¤ä¸ªå…³é”®é“¾æ¡

* Fault(bug) -> Error (ç¨‹åºçŠ¶æ€é”™è¯¯)ã€‚
  * å³ï¼šå¦‚ä½•å°†bugè½¬æˆç¨‹åºé”™è¯¯
  * éœ€è¦æ›´å¤šçš„æµ‹è¯•
    * æ„é€ å¤æ‚çš„ workloads
* Error(ç¨‹åºçŠ¶æ€é”™) -> Failure(å¯è§‚æµ‹çš„ç»“æœé”™)
  * éœ€è¦æ›´å¤šçš„æ£€æŸ¥
    * **éšæ—¶å¼€å…³å„ç±»æ—¥å¿—ä¿¡æ¯**
    * å„ç§é˜²å¾¡æ€§çš„ assertions



# å¹¶å‘BUGS

> æ­»é”ï¼š
>
> åŸå­æ€§è¿åï¼šå¿˜è®°ä¸Šé”ğŸ”’
>
> é¡ºåºè¿åï¼šå¿˜è®°åŒæ­¥

æ­»é”çš„ç±»å‹

* AA æ­»é”ï¼šåŒä¸€ä¸ªçº¿ç¨‹è·å–åŒä¸€ä¸ªé”ä¸¤æ¬¡
* ABBAæ­»é”ï¼šä¸€ä¸ªçº¿ç¨‹å…ˆè·å– A å†è·å– Bï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å…ˆè·å– B å†è·å– A





# æ“ä½œç³»ç»Ÿ

> ç®¡ç†ç¨‹åºè¿è¡Œçš„è½¯ä»¶
>
> åº”ç”¨ç¨‹åºï¼šä»£ç +æ•°æ®ï¼ˆæ–‡ä»¶ï¼‰=çŠ¶æ€æœº
>
> *  çŠ¶æ€
>   * å†…å­˜ + å¯„å­˜å™¨
>
> å…¶å®åº”ç”¨ç¨‹åºè‡ªå·±èƒ½å¹²çš„äº‹æƒ…æœ‰é™ï¼šåªèƒ½è¯»å–å†…å­˜çš„å€¼ï¼Œç„¶åè®¡ç®—ã€‚
>
> å…¶ä½™çš„åŠŸèƒ½éƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿæä¾›çš„ï¼šå†…å­˜ç”³è¯·ï¼Œè¯»æ–‡ä»¶ï¼Œå†™æ–‡ä»¶ï¼Œã€‚ã€‚ã€‚
>
> åº”ç”¨ç¨‹åºçœ¼ä¸­çš„æ“ä½œç³»ç»Ÿï¼šä»…ä»…æ˜¯ä¸€å †ç³»ç»Ÿè°ƒç”¨APIã€‚
>
> ç¡¬ä»¶çœ¼ä¸­çš„æ“ä½œç³»ç»Ÿï¼šä¸€æ®µCç¨‹åºä»£ç ã€‚

æ“ä½œç³»ç»Ÿç›¸æ¯”åº”ç”¨ç¨‹åºæœ‰å“ªäº›ç‰¹æ®Šï¼š

* å¯ä»¥çœ‹åˆ°æ•´å—ç‰©ç†å†…å­˜ï¼›åº”ç”¨ç¨‹åºçœ‹åˆ°çš„æ˜¯è™šæ‹Ÿå†…å­˜
* å¯ä»¥ä½¿ç”¨ä¸€äº›ç³»ç»Ÿå¯„å­˜å™¨ï¼ˆ`CR0, CR3, ...`ï¼‰
* å¯ä»¥å…³æ‰ç³»ç»Ÿä¸­æ–­ï¼Œåº”ç”¨ç¨‹åºæ˜¯ä¸å¯ä»¥å…³ç³»ç»Ÿä¸­æ–­çš„ã€‚
* å°†åº”ç”¨ç¨‹åºçš„å†…å­˜ å’Œ å¯„å­˜å™¨ç°åœºåŠ è½½åˆ°CPUä¸Šæ‰§è¡Œã€‚ï¼ˆå®é™…ä¸Šä¸€ä¸ªiretæŒ‡ä»¤å¥½åƒå°±å¯ä»¥ã€‚



æ“ä½œç³»ç»Ÿå¦‚ä½•è°ƒåº¦å¤šä¸ªç¨‹åºæ‰§è¡Œ

* å°†åº”ç”¨ç¨‹åºä»£ç åŠ è½½åˆ°å†…å­˜ï¼Œ
* ç„¶åå°† EIP å¯„å­˜å™¨æŒ‡å‘å¯¹åº”çš„ å†…å­˜åœ°å€ã€‚è¿™æ ·CPUå°±æ‰§è¡Œåº”ç”¨ç¨‹åºçš„ä»£ç äº†
* æ—¶é’Ÿâ°ä¸­æ–­æ¥äº†ï¼ŒCPUåˆå¼€å§‹æ‰§è¡Œæ“ä½œç³»ç»ŸæŒ‡ä»¤äº†ï¼Œ
  * è¿™æ—¶æ“ä½œç³»ç»Ÿä¼šä¿å­˜ä¸Šä¸€ä¸ªç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚
  * ç„¶åè°ƒåº¦æ‰§è¡Œä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚
* ã€‚ã€‚ã€‚



# è¿›ç¨‹æŠ½è±¡

> ç¨‹åº = çŠ¶æ€æœº
>
> è¿›ç¨‹ = çŠ¶æ€æœºçš„æ‰§è¡Œ
>
> æ“ä½œç³»ç»Ÿ = çŠ¶æ€æœºçš„æ¨¡æ‹Ÿå™¨ + ç³»ç»Ÿè°ƒç”¨
>
> Fork: å°†è¿›ç¨‹çœ‹ä½œçŠ¶æ€æœºåçš„ ä¸€æ¬¡ çŠ¶æ€æ‹·è´ï¼šä»£ç ã€æ•°æ®ã€æ ˆã€å¯„å­˜å™¨ã€‚
>
> forkï¼šéå¸¸æµªè´¹èµ„æºã€‚
>
> execve
>
> exit

exitï¼š

* `exit(0)`: `stdlib.h` ä¸­å£°æ˜çš„ `libc` å‡½æ•°
  * ä¼šè°ƒç”¨ `atexit`
* `_exit(0)`: `glibc` çš„ç³»ç»Ÿè°ƒç”¨ `wrapper`
  * ä¼šè°ƒç”¨ `exit_group` ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹
  * ä¸ä¼šè°ƒç”¨ `atexit`
* `syscall(SYS_exit, 0)`
  * æ‰§è¡Œ `exit` ç³»ç»Ÿè°ƒç”¨ï¼Œç»ˆæ­¢å½“å‰çº¿ç¨‹
  * ä¸ä¼šè°ƒç”¨ `atexit`
* å¾ˆå¤æ‚ï¼šåŒºåˆ†å¥½ åº“å‡½æ•°ï¼ˆåº”ç”¨ç¨‹åºä¸€éƒ¨åˆ†ï¼‰å’Œç³»ç»Ÿè°ƒç”¨å³å¯ã€‚



# æ“ä½œç³»ç»Ÿä¸­çš„è¿›ç¨‹

> è¿›ç¨‹æ‰§è¡ŒæŒ‡ä»¤éœ€è¦ ä»£ç ã€æ•°æ®ã€å †æ ˆ
>
> * ä»£ç 
> * æ•°æ®ï¼šå­—ç¬¦ä¸²å¸¸é‡
> * å †æ ˆï¼šå‡½æ•°è°ƒç”¨

```c
/*
main åœ¨ä»£ç åŒº
x åœ¨æ•°æ®åŒº
y åœ¨å †æ ˆä¸Š
*/
int main(int argc, char* argv[]) {
  static int x = 10;
  int y = 100;
}
```



**`è¿›ç¨‹çš„åœ°å€ç©ºé—´` **

* ä»£ç ã€æ•°æ®ã€å †æ ˆï¼ˆéƒ½å¯ä»¥é€šè¿‡æŒ‡é’ˆè®¿é—®
* åŠ¨æ€é“¾æ¥åº“
* è¿è¡Œæ—¶åˆ†é…å†…å­˜
* è¿›ç¨‹çš„åœ°å€ç©ºé—´å¯ä»¥ç†è§£æˆä¸ºä¸€æ®µä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œæ¯æ®µå†…å­˜éƒ½æœ‰è‡ªå·±çš„èŒè´£ï¼ˆä»£ç ï¼Œæ•°æ®ï¼Œå †æ ˆï¼ŒåŠ¨æ€é“¾æ¥åº“ï¼ŒåŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œetcã€‚
  * æ¯æ®µå†…å­˜æœ‰è‡ªå·±çš„æƒé™ & å¤§å°

> ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™æ˜¯å¯ä»¥åŠ¨æ€åŠ è½½åŠ¨æ€é“¾æ¥åº“çš„ï¼Œå°±æ˜¯å°†ä¸€æ®µæœªçŸ¥çš„ä»£ç åŠ è½½åˆ°å†…å­˜ä¸­ã€‚æ“ä½œç³»ç»Ÿå¦‚ä½•è¿›è¡Œè¿›ç¨‹çš„åœ°å€ç©ºé—´çš„åˆ›å»ºå’Œä¿®æ”¹å‘¢ï¼Ÿ



# è™šæ‹ŸåŒ–

> åˆ†é¡µæœºåˆ¶ï¼šç¡¬ä»¶æä¾›
>
> æ“ä½œç³»ç»Ÿåˆ©ç”¨åˆ†é¡µæœºåˆ¶å®ç°äº†è™šæ‹Ÿåœ°å€ç©ºé—´



> é“¾æ¥ä¸åŠ è½½
>
> * éœ€æ±‚ï¼šå…è®¸å¼•ç”¨å…¶å®ƒæ–‡ä»¶(Cæ ‡å‡†ç§°ä¹‹ä¸ºç¼–è¯‘å•å…ƒï¼Œcompilation unit) é‡Œå®šä¹‰çš„ç¬¦å·
>   * Cå¹¶ä¸é˜»æ­¢ä½ éšä¾¿å£°æ˜ç¬¦å·çš„ç±»å‹
>   * ä½†æ˜¯ç±»å‹ä¸åŒ¹é…ä¼šæ˜¯ undefined behavior

```c
// a.c
int foo(int a, int b) {
  return a + b;
}
```

```c
// b.c
int x = 100, y = 200;
```



```c
// main.c
extern int x, y;
int foo(int a, int b);
int main(int argv, char* argc[]) {
  foo(x, y);
}
```



é™æ€ELFåŠ è½½å™¨ï¼šåŠ è½½ `a.out` çš„æ‰§è¡Œ

* ç±»ä¼¼äº Abstract Machine ä¸­çš„ boot loader
  * æ ¹æ®ELF program headerï¼Œå°†æ–‡ä»¶ä¸­æŒ‡å®šçš„éƒ¨åˆ†ç§»åŠ¨åˆ°å†…å­˜
  * æ“ä½œç³»ç»Ÿåœ¨æ‰§è¡Œ `execve` çš„æ—¶å€™åšäº†å•¥ï¼Ÿ
    * æ“ä½œç³»ç»Ÿåœ¨å†…æ ¸æ€è°ƒç”¨ `mmap` 
      * è¿›ç¨‹è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œç”±å†…æ ¸ç›´æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨
      * æ˜ å°„å¥½ `a.out` ä»£ç ã€æ•°æ®ã€å †åŒºã€å †æ ˆã€vvarã€vdsoã€vsyscall
    * æ›´ç®€å•çš„å®ç°ï¼šç›´æ¥è¯»å…¥è¿›ç¨‹åœ°å€ç©ºé—´



# å¸¸ç”¨å·¥å…·

* gdb notes: http://csapp.cs.cmu.edu/3e/docs/gdbnotes-x86-64.pdf
* `nm` : æŸ¥çœ‹ç¬¦å·
* `strings`ï¼šæŸ¥çœ‹å­—ç¬¦ä¸²å¸¸é‡
* `size`ï¼šæŸ¥çœ‹æ–‡ä»¶å¤§å°
* `strace`ï¼šè¿½è¸ªç³»ç»Ÿè°ƒç”¨
* `ltrace`:  è¿½è¸ªåº“å‡½æ•°è°ƒç”¨
* `objdump`ï¼šæŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶
* `readelf`ï¼šæŸ¥çœ‹elf
* `make`
  * `-nB` ä¸å®é™…è¿›è¡Œç¼–è¯‘ï¼Œåªæ˜¯å°†ç¼–è¯‘è¿‡ç¨‹æ‰“å°å‡ºæ¥
* `pmap $pid`: æŸ¥çœ‹å†…å­˜çš„æ˜ å°„ã€‚

